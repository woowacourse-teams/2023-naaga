name: NAAGA BACKEND PRODUCT SERVER MERGE CI/CD

on:
  push:
    branches:
      - main_temp
    paths:
      - backend/**
      
jobs:
  github_actions_setting:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ í”„ë¡œì íŠ¸ íŒŒì¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘... ğŸ“‚
        uses: actions/checkout@v3
        with:
          submodules: true
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: â˜•ï¸ ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì— JDK 17 ì ìš©ì‹œí‚¤ëŠ” ì¤‘... â˜•ï¸
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: ğŸ˜ Gradle ì„¸íŒ… ì¤‘... ğŸ˜
        uses: gradle/gradle-build-action@v2.6.0

      - name: âš™ï¸ Gradle ë¡œ JAR íŒŒì¼ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ì¤‘... âš™ï¸
        run: |
          cd backend
          ./gradlew clean bootJar -Dspring.profiles.active=test

      - name: ğŸ³ ë„ì»¤ ì„¸íŒ… ì¤‘... ğŸ³
        uses: docker/setup-buildx-action@v2.9.1

      - name: ğŸ³ ë„ì»¤ í—ˆë¸Œì— ë¡œê·¸ì¸ ì¤‘... ğŸ³
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESSTOKEN }}

      - name: ğŸ³ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘... ğŸ³
        run: |
          cd backend
          docker build --platform linux/amd64 -t ${{ secrets.DOCKERHUB_REPOSITORY }}/${{ secrets.DOCKERHUB_APPNAME }} -f Dockerfile-prod .

      - name: ğŸ³ ë„ì»¤ í—ˆë¸Œì— Push ì¤‘... ğŸ³
        run: docker push ${{ secrets.DOCKERHUB_REPOSITORY }}/${{ secrets.DOCKERHUB_APPNAME }}

      - name: ğŸ™ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ... ğŸ™
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_ID }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            cd /home/ubuntu/naaga/prod
            sudo ./deploy.sh
